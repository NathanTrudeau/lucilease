<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lucilease</title>
  <style>
    :root {
      --bg:       #0f1117;
      --surface:  #1a1d27;
      --border:   #2a2d3a;
      --accent:   #6c63ff;
      --accent2:  #a78bfa;
      --text:     #e2e8f0;
      --muted:    #64748b;
      --green:    #22c55e;
      --yellow:   #f59e0b;
      --red:      #ef4444;
      --sidebar-w: 220px;
    }

    /* â”€â”€ Theme swatches â”€â”€ */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .swatch {
      width: 100%; aspect-ratio: 1;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: transform 0.15s, border-color 0.15s;
    }
    .swatch:hover { transform: scale(1.1); }
    .swatch.selected { border-color: var(--text); }

    /* â”€â”€ Signature toolbar â”€â”€ */
    .sig-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .sig-toolbar button {
      background: var(--border);
      color: var(--text);
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 5px;
      min-width: unset;
    }
    .sig-toolbar select {
      background: var(--border);
      color: var(--text);
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .sig-editor {
      min-height: 80px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      outline: none;
      line-height: 1.5;
    }
    .sig-editor:focus { border-color: var(--accent); }
    .sig-editor:empty:before {
      content: attr(placeholder);
      color: var(--muted);
      pointer-events: none;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
    }

    /* â”€â”€ Sidebar â”€â”€ */
    aside {
      width: var(--sidebar-w);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .logo { padding: 24px 20px 20px; border-bottom: 1px solid var(--border); }
    .logo h1 { font-size: 20px; font-weight: 700; color: var(--accent2); letter-spacing: -0.5px; }
    .logo p  { font-size: 11px; color: var(--muted); margin-top: 2px; }

    nav { padding: 12px 8px; flex: 1; }

    nav a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 8px;
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 2px;
    }

    nav a:hover { background: var(--border); color: var(--text); }
    nav a.active { background: rgba(108, 99, 255, 0.15); color: var(--accent2); }
    nav a .icon { font-size: 16px; width: 20px; text-align: center; }

    .badge {
      margin-left: auto;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 20px;
      min-width: 18px;
      text-align: center;
    }
    .badge.zero { background: var(--border); color: var(--muted); }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
    }

    .status-dot {
      display: inline-block;
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--green);
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    .status-dot.offline { background: var(--red); animation: none; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* â”€â”€ Main â”€â”€ */
    main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    header {
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface);
      flex-shrink: 0;
    }

    header h2 { font-size: 16px; font-weight: 600; }
    header p  { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }

    /* â”€â”€ Buttons â”€â”€ */
    button, .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 7px 14px;
      border-radius: 7px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    button:hover, .btn:hover { opacity: 0.85; }
    button.secondary, .btn.secondary { background: var(--border); color: var(--text); }
    button.danger { background: rgba(239,68,68,0.15); color: var(--red); }
    button.success { background: rgba(34,197,94,0.15); color: var(--green); }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ Content â”€â”€ */
    .content { flex: 1; overflow-y: auto; padding: 28px; }

    /* â”€â”€ Stats â”€â”€ */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 20px;
    }
    .stat-card .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 6px; }
    .stat-card .sub   { font-size: 11px; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ Alert banner â”€â”€ */
    .banner {
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }
    .banner.warn  { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: var(--yellow); }
    .banner.info  { background: rgba(108,99,255,0.1); border: 1px solid rgba(108,99,255,0.3); color: var(--accent2); }
    .banner.good  { background: rgba(34,197,94,0.1);  border: 1px solid rgba(34,197,94,0.3);  color: var(--green); }
    .banner a { color: inherit; font-weight: 600; }

    /* â”€â”€ Panel â”€â”€ */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .panel-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
    }

    /* â”€â”€ Table â”€â”€ */
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
    }
    td {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    .tag {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .tag.new      { background: rgba(108,99,255,0.2);  color: var(--accent2); }
    .tag.handled  { background: rgba(34,197,94,0.15);  color: var(--green); }
    .tag.active   { background: rgba(34,197,94,0.15);  color: var(--green); }
    .tag.inactive { background: rgba(100,116,139,0.2); color: var(--muted); }
    .tag.closed   { background: rgba(239,68,68,0.15);  color: var(--red); }
    .tag.tbd      { background: rgba(245,158,11,0.18); color: var(--yellow); }
    .tag.rental   { background: rgba(245,158,11,0.15); color: var(--yellow); }
    .tag.sale     { background: rgba(239,68,68,0.15);  color: var(--red); }

    /* Tight table */
    table.tight td, table.tight th { padding: 8px 10px; }
    .notes-cell {
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--muted);
      font-size: 12px;
    }

    /* Sort button active */
    button.sort-active { background: rgba(108,99,255,0.2); color: var(--accent2); }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; }

    /* â”€â”€ Empty state â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--muted);
    }
    .empty-state .icon { font-size: 36px; margin-bottom: 12px; }
    .empty-state p { font-size: 13px; }

    /* â”€â”€ Settings form â”€â”€ */
    .settings-section { margin-bottom: 28px; }
    .settings-section h3 { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--text); }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 13px; font-weight: 500; }
    .setting-desc  { font-size: 11px; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ Page visibility â”€â”€ */
    .page { display: none; flex-direction: column; height: 100%; overflow: hidden; }
    .page.active { display: flex; }

    /* â”€â”€ Modal â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 28px;
      width: 480px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 { font-size: 15px; font-weight: 600; margin-bottom: 20px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }

    /* â”€â”€ Form â”€â”€ */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; font-weight: 500; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 9px 12px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 7px; color: var(--text); font-size: 13px;
      outline: none; transition: border-color 0.15s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--accent);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* â”€â”€ Toggle switch â”€â”€ */
    .toggle-track {
      width: 36px; height: 20px;
      background: var(--border);
      border-radius: 20px;
      position: relative;
      transition: background 0.2s;
      cursor: pointer;
    }
    .toggle-track.on { background: var(--accent); }
    .toggle-thumb {
      width: 14px; height: 14px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 3px; left: 3px;
      transition: left 0.2s;
    }
    .toggle-track.on .toggle-thumb { left: 19px; }

    /* â”€â”€ Draft preview â”€â”€ */
    .draft-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      color: var(--text);
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside>
  <div class="logo">
    <h1>Lucilease</h1>
    <p>Real Estate AI Assistant</p>
    <p id="app-version" style="margin-top:5px;font-size:10px;color:#3a3d50;font-weight:700;letter-spacing:0.6px">v0.3.0</p>
  </div>

  <nav>
    <a class="active" onclick="showPage('dashboard', this)">
      <span class="icon">ğŸ </span> Dashboard
    </a>
    <a onclick="showPage('inbox', this)">
      <span class="icon">ğŸ“¬</span> Inbox
      <span class="badge zero" id="inbox-badge">0</span>
    </a>
    <a onclick="showPage('drafts', this)">
      <span class="icon">âœ</span> Drafts
      <span class="badge zero" id="drafts-badge">0</span>
    </a>
    <a onclick="showPage('clients', this)">
      <span class="icon">ğŸ‘¥</span> Clients
    </a>
    <a onclick="showPage('properties', this)">
      <span class="icon">ğŸ¢</span> Properties
    </a>
    <a onclick="showPage('calendar', this)">
      <span class="icon">ğŸ“…</span> Calendar
    </a>
    <a onclick="showPage('settings', this)">
      <span class="icon">âš™ï¸</span> Settings
    </a>
  </nav>

  <div class="sidebar-footer">
    <span class="status-dot" id="status-dot"></span>
    <span id="status-text">Checking...</span>
  </div>
</aside>

<!-- â”€â”€ Draft Modal â”€â”€ -->
<div class="modal-overlay" id="draft-modal">
  <div class="modal" style="width:560px">
    <h3>âœ Draft Reply</h3>
    <div id="draft-modal-content">
      <p style="color:var(--muted);text-align:center;padding:20px">Generating with Claude...</p>
    </div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('draft-modal')">Close</button>
      <a id="draft-gmail-link" class="btn" href="#" target="_blank" style="display:none">Open in Gmail â†’</a>
    </div>
  </div>
</div>

<!-- â”€â”€ Add Property Modal â”€â”€ -->
<!-- property-modal replaced by property-edit-modal -->

<!-- â”€â”€ Agent Profile Modal â”€â”€ -->
<div class="modal-overlay" id="profile-modal">
  <div class="modal" style="width:520px">
    <h3>ğŸ‘¤ Agent Profile</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Your Name</label>
        <input id="profile-name" type="text" placeholder="Jane Smith" />
      </div>
      <div class="form-group">
        <label>Company</label>
        <input id="profile-company" type="text" placeholder="Santa Barbara Realty" />
      </div>
    </div>
    <div class="form-group">
      <label>Reply Tone</label>
      <select id="profile-tone">
        <option value="professional and warm">Professional &amp; Warm</option>
        <option value="friendly and conversational">Friendly &amp; Conversational</option>
        <option value="concise and direct">Concise &amp; Direct</option>
        <option value="formal and corporate">Formal &amp; Corporate</option>
      </select>
    </div>
    <div class="form-group">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <label style="margin:0">Custom Signature</label>
        <div style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--muted)" onclick="toggleSig()">
          <span id="sig-toggle-label">Off</span>
          <div class="toggle-track" id="sig-track">
            <div class="toggle-thumb"></div>
          </div>
        </div>
      </div>
      <div id="sig-editor-wrap" style="display:none">
      <div class="sig-toolbar">
        <button type="button" onclick="sigFmt('bold')"><b>B</b></button>
        <button type="button" onclick="sigFmt('italic')"><i>I</i></button>
        <button type="button" onclick="sigFmt('underline')"><u>U</u></button>
        <select onchange="sigFmt('fontSize', this.value); this.value=''">
          <option value="">Size</option>
          <option value="1">Small</option>
          <option value="3">Normal</option>
          <option value="4">Large</option>
          <option value="5">X-Large</option>
        </select>
        <select onchange="sigFmt('fontName', this.value); this.value=''">
          <option value="">Font</option>
          <option value="Arial">Arial</option>
          <option value="Georgia">Georgia</option>
          <option value="Helvetica">Helvetica</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
        </select>
      </div>
      <div id="sig-editor" class="sig-editor" contenteditable="true"
           placeholder="e.g. Jane Smith | Santa Barbara Realty | (805) 555-0100"></div>
      </div><!-- /sig-editor-wrap -->
    </div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('profile-modal')">Cancel</button>
      <button onclick="saveProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Edit Client Modal â”€â”€ -->
<div class="modal-overlay" id="client-edit-modal">
  <div class="modal" style="width:480px">
    <h3 id="client-edit-title">ğŸ‘¤ Edit Client</h3>
    <input type="hidden" id="client-edit-id" value="" />
    <div class="form-row">
      <div class="form-group">
        <label>Name</label>
        <input id="client-edit-name" type="text" placeholder="Jane Smith" />
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="client-edit-status">
          <option value="tbd">TBD</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="closed">Closed</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Email</label>
        <input id="client-edit-email" type="email" placeholder="jane@email.com" />
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input id="client-edit-phone" type="text" placeholder="(805) 555-0100" />
      </div>
    </div>
    <div class="form-group">
      <label>Address</label>
      <input id="client-edit-address" type="text" placeholder="123 Main St, Santa Barbara, CA" />
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="client-edit-notes" placeholder="Anything to remember about this client..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('client-edit-modal')">Cancel</button>
      <button onclick="saveClient()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Edit Property Modal â”€â”€ -->
<div class="modal-overlay" id="property-edit-modal">
  <div class="modal" style="width:520px">
    <h3 id="property-edit-title">ğŸ¢ Add Property</h3>
    <input type="hidden" id="prop-edit-id" value="" />
    <div class="form-group">
      <label>Address</label>
      <input id="prop-edit-address" type="text" placeholder="123 Main St, Santa Barbara, CA" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Type</label>
        <select id="prop-edit-type">
          <option value="rental">Rental</option>
          <option value="sale">For Sale</option>
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="prop-edit-status">
          <option value="tbd">TBD</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="closed">Closed</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Monthly Rent ($)</label>
        <input id="prop-edit-price-monthly" type="number" placeholder="3500" />
      </div>
      <div class="form-group">
        <label>Sale Price ($)</label>
        <input id="prop-edit-price-sale" type="number" placeholder="650000" />
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Bedrooms</label>
        <input id="prop-edit-bedrooms" type="number" placeholder="2" />
      </div>
      <div class="form-group">
        <label>Bathrooms</label>
        <input id="prop-edit-bathrooms" type="number" step="0.5" placeholder="1.5" />
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="prop-edit-notes" placeholder="Pet-friendly, parking included..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('property-edit-modal')">Cancel</button>
      <button onclick="saveProperty()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€ View Notes Modal â”€â”€ -->
<div class="modal-overlay" id="notes-modal">
  <div class="modal" style="width:460px">
    <h3 id="notes-modal-title">ğŸ“ Notes</h3>
    <div id="notes-modal-body" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;font-size:13px;line-height:1.7;white-space:pre-wrap;max-height:360px;overflow-y:auto;color:var(--text)"></div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('notes-modal')">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Theme Picker Modal â”€â”€ -->
<div class="modal-overlay" id="theme-modal">
  <div class="modal" style="width:360px">
    <h3>ğŸ¨ Theme Color</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">Choose an accent color for the interface.</p>
    <p style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px">Soft</p>
    <div class="color-grid" id="soft-swatches"></div>
    <p style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;margin:16px 0 8px">Vivid</p>
    <div class="color-grid" id="vivid-swatches"></div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('theme-modal')">Done</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New / Edit Draft Modal â”€â”€ -->
<div class="modal-overlay" id="draft-edit-modal">
  <div class="modal" style="width:600px">
    <h3 id="draft-edit-title">âœ New Draft</h3>
    <input type="hidden" id="draft-edit-id" value="" />
    <div class="form-group">
      <label>To</label>
      <div style="display:flex;gap:8px">
        <input id="draft-edit-to" type="email" placeholder="recipient@email.com" style="flex:1" />
        <button class="secondary" onclick="openClientPicker()" style="white-space:nowrap">Pick Client</button>
      </div>
    </div>
    <div class="form-group">
      <label>Subject</label>
      <input id="draft-edit-subject" type="text" placeholder="Re: Property Inquiry" />
    </div>
    <div class="form-group">
      <label>Body</label>
      <div class="sig-toolbar">
        <button type="button" onclick="draftFmt('bold')"><b>B</b></button>
        <button type="button" onclick="draftFmt('italic')"><i>I</i></button>
        <button type="button" onclick="draftFmt('underline')"><u>U</u></button>
        <select onchange="draftFmt('fontSize', this.value); this.value=''">
          <option value="">Size</option>
          <option value="1">Small</option>
          <option value="3">Normal</option>
          <option value="4">Large</option>
          <option value="5">X-Large</option>
        </select>
        <select onchange="draftFmt('fontName', this.value); this.value=''">
          <option value="">Font</option>
          <option value="Arial">Arial</option>
          <option value="Georgia">Georgia</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
        </select>
      </div>
      <div id="draft-edit-body" class="sig-editor" contenteditable="true"
           style="min-height:180px" placeholder="Write your email here..."></div>
    </div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('draft-edit-modal')">Cancel</button>
      <button class="secondary" onclick="saveDraft('local')">ğŸ’¾ Save Local</button>
      <button onclick="saveDraft('gmail')">ğŸ“¨ Push to Gmail Drafts</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Client Picker Modal â”€â”€ -->
<div class="modal-overlay" id="client-picker-modal">
  <div class="modal" style="width:400px">
    <h3>ğŸ‘¥ Pick a Client</h3>
    <div id="client-picker-list" style="max-height:300px;overflow-y:auto"></div>
    <div class="modal-footer">
      <button class="secondary" onclick="closeModal('client-picker-modal')">Cancel</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Send All Confirm Modal â”€â”€ -->
<div class="modal-overlay" id="send-all-modal">
  <div class="modal" style="width:480px;border:1px solid var(--red)">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:40px;margin-bottom:12px">âš ï¸</div>
      <h3 style="font-size:18px;color:var(--red)">SEND ALL EMAILS?</h3>
    </div>
    <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:16px;margin-bottom:20px;font-size:13px;line-height:1.6">
      <strong>Have you reviewed every draft and are happy with them?</strong><br/><br/>
      This will send all pending drafts directly to their recipients via Gmail.
      <strong>This cannot be undone.</strong> Any emails that fail to send will remain
      in your Drafts tab so you can retry or fix them.
    </div>
    <div style="font-size:12px;color:var(--muted);text-align:center;margin-bottom:20px" id="send-all-count">
      Loading draft count...
    </div>
    <div class="modal-footer" style="justify-content:center;gap:16px">
      <button class="secondary" style="padding:10px 24px" onclick="closeModal('send-all-modal')">
        Cancel â€” Go Back and Review
      </button>
      <button class="danger" style="padding:10px 24px;background:var(--red);color:#fff" onclick="executeSendAll()">
        Yes, Send All Now
      </button>
    </div>
  </div>
</div>

<!-- Main -->
<main>

  <!-- â”€â”€ Dashboard â”€â”€ -->
  <div id="page-dashboard" class="page active">
    <header>
      <div>
        <h2>Dashboard</h2>
        <p id="header-date">â€”</p>
      </div>
      <div class="header-actions">
        <button class="secondary" onclick="refreshAll()">â†» Refresh</button>
      </div>
    </header>
    <div class="content">

      <div id="gmail-banner"></div>

      <div class="stats">
        <div class="stat-card">
          <div class="label">New Leads</div>
          <div class="value" id="stat-leads-new">â€”</div>
          <div class="sub">Awaiting review</div>
        </div>
        <div class="stat-card">
          <div class="label">Total Leads</div>
          <div class="value" id="stat-leads-total">â€”</div>
          <div class="sub">All time</div>
        </div>
        <div class="stat-card">
          <div class="label">Clients</div>
          <div class="value" id="stat-clients">â€”</div>
          <div class="sub">Active contacts</div>
        </div>
        <div class="stat-card">
          <div class="label">Properties</div>
          <div class="value" id="stat-properties">â€”</div>
          <div class="sub">Active listings</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          Recent Leads
          <button class="secondary" onclick="showPage('inbox', document.querySelector('nav a:nth-child(2)'))">View all â†’</button>
        </div>
        <div id="recent-leads-container">
          <div class="empty-state"><div class="icon">ğŸ“­</div><p>No leads yet.</p></div>
        </div>
      </div>

    </div>
  </div>

  <!-- â”€â”€ Inbox â”€â”€ -->
  <div id="page-inbox" class="page">
    <header>
      <div>
        <h2>Inbox</h2>
        <p>Incoming lead emails</p>
      </div>
      <div class="header-actions">
        <button class="secondary" onclick="manualPoll()" id="poll-btn">â†» Check now</button>
      </div>
    </header>
    <div class="content">
      <div class="panel">
        <div class="panel-header">
          New Leads
          <span id="leads-count" style="color:var(--muted);font-weight:400;font-size:12px;"></span>
        </div>
        <div id="leads-container">
          <div class="empty-state"><div class="icon">ğŸ“¬</div><p>Loading...</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Drafts â”€â”€ -->
  <div id="page-drafts" class="page">
    <header>
      <div><h2>Drafts</h2><p>Review, edit, and send your outgoing emails</p></div>
      <div class="header-actions">
        <button onclick="openNewDraftModal()">+ New Draft</button>
        <button class="danger" id="send-all-btn" onclick="confirmSendAll()" style="font-weight:700;letter-spacing:0.3px">ğŸ“¤ SEND ALL EMAILS</button>
      </div>
    </header>
    <div class="content">
      <div class="panel">
        <div class="panel-header">
          Pending Drafts
          <span id="drafts-count" style="color:var(--muted);font-weight:400;font-size:12px"></span>
        </div>
        <div id="drafts-container">
          <div class="empty-state"><div class="icon">âœ</div><p>No drafts yet.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Clients â”€â”€ -->
  <div id="page-clients" class="page">
    <header>
      <div><h2>Clients</h2><p>Your contact list</p></div>
      <div class="header-actions"><button onclick="openEditClient({})">+ Add Client</button></div>
    </header>
    <div class="content">
      <!-- Summary bar -->
      <div id="clients-summary" class="stats" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px"></div>
      <!-- Sort controls -->
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--muted)">Sort:</span>
        <button class="secondary" id="csort-status" onclick="setClientSort('status')" style="font-size:12px;padding:5px 10px">Status â†•</button>
        <button class="secondary" id="csort-first"  onclick="setClientSort('first')"  style="font-size:12px;padding:5px 10px">First Name â†•</button>
        <button class="secondary" id="csort-last"   onclick="setClientSort('last')"   style="font-size:12px;padding:5px 10px">Last Name â†•</button>
      </div>
      <div class="panel">
        <div id="clients-container">
          <div class="empty-state"><div class="icon">ğŸ‘¥</div><p>No clients yet.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Properties â”€â”€ -->
  <div id="page-properties" class="page">
    <header>
      <div><h2>Properties</h2><p>Your active listings</p></div>
      <div class="header-actions"><button onclick="openAddPropertyModal()">+ Add Property</button></div>
    </header>
    <div class="content">
      <!-- Summary bar -->
      <div id="props-summary" class="stats" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px"></div>
      <!-- Sort controls -->
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--muted)">Sort:</span>
        <button class="secondary" id="psort-status"  onclick="setPropSort('status')"  style="font-size:12px;padding:5px 10px">Status â†•</button>
        <button class="secondary" id="psort-address" onclick="setPropSort('address')" style="font-size:12px;padding:5px 10px">Address â†•</button>
        <button class="secondary" id="psort-price"   onclick="setPropSort('price')"   style="font-size:12px;padding:5px 10px">Price â†•</button>
      </div>
      <div class="panel">
        <div id="properties-container">
          <div class="empty-state"><div class="icon">ğŸ¢</div><p>No properties yet.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Calendar â”€â”€ -->
  <div id="page-calendar" class="page">
    <header><div><h2>Calendar</h2><p>Upcoming appointments</p></div></header>
    <div class="content">
      <div class="panel">
        <div class="empty-state"><div class="icon">ğŸ“…</div><p>Google Calendar integration â€” coming in Phase 4.</p></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Settings â”€â”€ -->
  <div id="page-settings" class="page">
    <header><div><h2>Settings</h2><p>Configure your Lucilease agent</p></div></header>
    <div class="content">

      <div class="panel settings-section">
        <div class="panel-header">Gmail Connection</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Connected Account</div>
            <div class="setting-desc" id="gmail-account-display">Checking...</div>
          </div>
          <div id="gmail-connect-btn">
            <button class="secondary" disabled>...</button>
          </div>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Poll Interval</div>
            <div class="setting-desc">How often Lucilease checks for new emails</div>
          </div>
          <div style="color:var(--muted);font-size:13px;" id="poll-interval-display">â€”</div>
        </div>
      </div>

      <div class="panel settings-section">
        <div class="panel-header">Agent &amp; AI</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Agent Profile</div>
            <div class="setting-desc">Your name, company, tone, and email signature</div>
          </div>
          <button onclick="openProfileModal()">Edit Profile</button>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Google Calendar</div>
            <div class="setting-desc">Connect to schedule appointments from emails</div>
          </div>
          <button class="secondary" disabled>Phase 4</button>
        </div>
      </div>

      <div class="panel settings-section">
        <div class="panel-header">Appearance</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Theme Color</div>
            <div class="setting-desc">Customize the accent color of the interface</div>
          </div>
          <button onclick="openModal('theme-modal')">ğŸ¨ Change Color</button>
        </div>
      </div>

    </div>
  </div>

</main>

<script>
  // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showPage(name, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    if (el) el.classList.add('active');
    if (name === 'inbox')      loadLeads();
    if (name === 'drafts')     loadDrafts();
    if (name === 'clients')    loadClients();
    if (name === 'properties') loadProperties();
  }

  // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SOFT_COLORS  = [
    { name: 'Lavender', accent: '#c4b5fd', accent2: '#ddd6fe' },
    { name: 'Sky',      accent: '#93c5fd', accent2: '#bfdbfe' },
    { name: 'Mint',     accent: '#6ee7b7', accent2: '#a7f3d0' },
    { name: 'Peach',    accent: '#fca5a5', accent2: '#fecaca' },
    { name: 'Rose',     accent: '#f9a8d4', accent2: '#fbcfe8' },
  ];
  const VIVID_COLORS = [
    { name: 'Purple',   accent: '#6c63ff', accent2: '#a78bfa' },
    { name: 'Blue',     accent: '#2563eb', accent2: '#60a5fa' },
    { name: 'Emerald',  accent: '#059669', accent2: '#34d399' },
    { name: 'Coral',    accent: '#e11d48', accent2: '#fb7185' },
    { name: 'Teal',     accent: '#0891b2', accent2: '#22d3ee' },
  ];

  function applyTheme(accent, accent2) {
    document.documentElement.style.setProperty('--accent', accent);
    document.documentElement.style.setProperty('--accent2', accent2);
    localStorage.setItem('ll-accent',  accent);
    localStorage.setItem('ll-accent2', accent2);
  }

  function buildSwatches() {
    const selected = localStorage.getItem('ll-accent') || '#6c63ff';

    function renderGroup(colors, containerId) {
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      colors.forEach(c => {
        const s = document.createElement('div');
        s.className = 'swatch' + (c.accent === selected ? ' selected' : '');
        s.style.background = c.accent;
        s.title = c.name;
        s.onclick = () => {
          document.querySelectorAll('.swatch').forEach(x => x.classList.remove('selected'));
          s.classList.add('selected');
          applyTheme(c.accent, c.accent2);
        };
        el.appendChild(s);
      });
    }
    renderGroup(SOFT_COLORS,  'soft-swatches');
    renderGroup(VIVID_COLORS, 'vivid-swatches');
  }

  // Apply saved theme on load
  const savedAccent  = localStorage.getItem('ll-accent');
  const savedAccent2 = localStorage.getItem('ll-accent2');
  if (savedAccent && savedAccent2) applyTheme(savedAccent, savedAccent2);

  // â”€â”€ Auth status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let isAuthed = false;

  async function checkAuth() {
    try {
      const r = await fetch('/auth/status');
      const d = await r.json();
      isAuthed = d.authenticated;

      const dot    = document.getElementById('status-dot');
      const text   = document.getElementById('status-text');
      const btn    = document.getElementById('gmail-connect-btn');
      const banner = document.getElementById('gmail-banner');
      const acctEl = document.getElementById('gmail-account-display');

      if (isAuthed) {
        dot.className    = 'status-dot';
        text.textContent = 'Gmail connected';
        btn.innerHTML    = `<button class="danger" onclick="disconnectGmail()">Disconnect</button>
                            <a class="btn secondary" href="/auth/gmail" style="margin-left:8px">Swap account</a>`;
        banner.innerHTML = '';
        // Fetch account email
        const ar = await fetch('/api/gmail-account');
        const ad = await ar.json();
        if (ad.email) acctEl.textContent = ad.email;
      } else {
        dot.className    = 'status-dot offline';
        text.textContent = 'Gmail not connected';
        btn.innerHTML    = '<a class="btn" href="/auth/gmail">Connect Gmail â†’</a>';
        if (acctEl) acctEl.textContent = 'Not connected';
        banner.innerHTML = `
          <div class="banner warn">
            âš ï¸ Gmail is not connected.
            <a href="/auth/gmail">Connect now</a> to start receiving leads.
          </div>`;
      }
    } catch(e) {
      console.error('Auth check failed', e);
    }
  }

  async function disconnectGmail() {
    if (!confirm('Disconnect Gmail? Lucilease will stop checking for new leads until reconnected.')) return;
    await fetch('/auth/gmail', { method: 'DELETE' });
    await checkAuth();
  }

  // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function refreshStats() {
    try {
      const r = await fetch('/api/stats');
      const d = await r.json();
      document.getElementById('stat-leads-new').textContent   = d.leads_new;
      document.getElementById('stat-leads-total').textContent = d.leads_total;
      document.getElementById('stat-clients').textContent     = d.clients;
      document.getElementById('stat-properties').textContent  = d.properties;

      const badge = document.getElementById('inbox-badge');
      badge.textContent = d.leads_new;
      badge.className   = 'badge' + (d.leads_new > 0 ? '' : ' zero');
    } catch(e) { console.error('Stats failed', e); }
  }

  // â”€â”€ Leads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadLeads() {
    const container = document.getElementById('leads-container');
    try {
      const [leadsRes, clientsRes] = await Promise.all([
        fetch('/api/leads?status=new'),
        fetch('/api/clients'),
      ]);
      const leads = await leadsRes.json();
      const existingEmails = new Set((await clientsRes.json()).map(c => (c.email || '').toLowerCase()));

      document.getElementById('leads-count').textContent =
        leads.length ? `${leads.length} new` : '';

      if (!leads.length) {
        container.innerHTML = `<div class="empty-state">
          <div class="icon">ğŸ“­</div>
          <p>${isAuthed ? 'No new leads. Inbox is clear.' : 'Connect Gmail in Settings to start.'}</p>
        </div>`;
        return;
      }

      container.innerHTML = `
        <table>
          <thead><tr>
            <th>Name</th><th>Email</th><th>Phone</th>
            <th>Subject</th><th>Budget</th><th>Received</th><th>Actions</th>
          </tr></thead>
          <tbody>
            ${leads.map(l => `
              <tr id="lead-row-${l.id}">
                <td>${l.name || 'â€”'}</td>
                <td><a href="mailto:${l.from_email}" style="color:var(--accent2)">${l.from_email}</a></td>
                <td>${l.phone || 'â€”'}</td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.subject || 'â€”'}</td>
                <td>${l.budget_monthly_usd ? '$' + l.budget_monthly_usd.toLocaleString() + '/mo' : 'â€”'}</td>
                <td style="color:var(--muted);font-size:12px">${formatDate(l.first_seen_at)}</td>
                <td>
                  <div class="actions">
                    <button onclick="generateDraft(${l.id}, this)">âœ Draft</button>
                    ${existingEmails.has(l.from_email.toLowerCase())
                      ? `<button class="success" disabled title="Already in client list">âœ“ In DB</button>`
                      : `<button class="success" onclick="addClient(${l.id})">+ Client</button>`}
                    <button class="secondary" onclick="handleLead(${l.id})" title="Mark as handled â€” removes from inbox">âœ“ Dismiss</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;

      // Also update dashboard recent leads
      updateRecentLeads(leads.slice(0, 5));
    } catch(e) {
      container.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><p>Failed to load leads.</p></div>`;
    }
  }

  function updateRecentLeads(leads) {
    const el = document.getElementById('recent-leads-container');
    if (!leads.length) {
      el.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“­</div><p>No leads yet.</p></div>`;
      return;
    }
    el.innerHTML = `
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Subject</th><th>Budget</th><th>Received</th></tr></thead>
        <tbody>
          ${leads.map(l => `
            <tr>
              <td>${l.name || 'â€”'}</td>
              <td style="color:var(--accent2)">${l.from_email}</td>
              <td>${l.subject || 'â€”'}</td>
              <td>${l.budget_monthly_usd ? '$' + l.budget_monthly_usd.toLocaleString() + '/mo' : 'â€”'}</td>
              <td style="color:var(--muted);font-size:12px">${formatDate(l.first_seen_at)}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }

  async function handleLead(id) {
    await fetch(`/api/leads/${id}/handle`, { method: 'POST' });
    document.getElementById(`lead-row-${id}`)?.remove();
    refreshStats();
  }

  async function addClient(id) {
    const r = await fetch(`/api/leads/${id}/add-client`, { method: 'POST' });
    const d = await r.json();
    if (d.ok) {
      await loadLeads();   // refreshes button state â†’ shows "âœ“ In DB"
      await refreshStats();
    }
  }

  async function manualPoll() {
    const btn = document.getElementById('poll-btn');
    btn.disabled = true;
    btn.textContent = 'Checking...';
    try {
      const r = await fetch('/api/poll', { method: 'POST' });
      const d = await r.json();
      btn.textContent = `â†» Check now (${d.new_leads} new)`;
      await loadLeads();
      await refreshStats();
    } catch(e) {
      btn.textContent = 'â†» Check now';
    }
    btn.disabled = false;
  }

  // â”€â”€ Status helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const STATUS_ORDER = { tbd: 0, active: 1, inactive: 2, closed: 3 };
  function statusTag(s) {
    return `<span class="tag ${s || 'active'}">${s || 'active'}</span>`;
  }

  // â”€â”€ Clients â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _clientsCache = [];
  let _clientSort   = { field: 'status', dir: 1 };

  function setClientSort(field) {
    if (_clientSort.field === field) _clientSort.dir *= -1;
    else _clientSort = { field, dir: 1 };
    document.querySelectorAll('[id^="csort-"]').forEach(b => b.classList.remove('sort-active'));
    document.getElementById(`csort-${field}`)?.classList.add('sort-active');
    renderClients();
  }

  function sortClients(clients) {
    return [...clients].sort((a, b) => {
      const { field, dir } = _clientSort;
      if (field === 'status') {
        const diff = (STATUS_ORDER[a.status] ?? 1) - (STATUS_ORDER[b.status] ?? 1);
        return diff !== 0 ? diff : a.name.localeCompare(b.name);
      }
      if (field === 'first') {
        const af = a.name.split(' ')[0] || '', bf = b.name.split(' ')[0] || '';
        return dir * af.localeCompare(bf);
      }
      if (field === 'last') {
        const ap = a.name.split(' '), bp = b.name.split(' ');
        const al = ap[ap.length-1] || '', bl = bp[bp.length-1] || '';
        return dir * al.localeCompare(bl);
      }
      return 0;
    });
  }

  function renderClientSummary(clients) {
    const counts = { tbd: 0, active: 0, inactive: 0, closed: 0 };
    clients.forEach(c => { counts[c.status] = (counts[c.status] || 0) + 1; });
    const items = [
      { label: 'TBD',      key: 'tbd',      color: 'var(--yellow)' },
      { label: 'Active',   key: 'active',   color: 'var(--green)'  },
      { label: 'Inactive', key: 'inactive', color: 'var(--muted)'  },
      { label: 'Closed',   key: 'closed',   color: 'var(--red)'    },
    ];
    document.getElementById('clients-summary').innerHTML = items.map(i => `
      <div class="stat-card">
        <div class="label">${i.label}</div>
        <div class="value" style="font-size:24px;color:${i.color}">${counts[i.key] || 0}</div>
        <div class="sub">Clients</div>
      </div>`).join('');
  }

  function renderClients() {
    const container = document.getElementById('clients-container');
    const clients = sortClients(_clientsCache);
    if (!clients.length) {
      container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>No clients yet.</p></div>`;
      return;
    }
    container.innerHTML = `
      <table class="tight">
        <thead><tr>
          <th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Notes</th><th>Added</th><th></th>
        </tr></thead>
        <tbody>
          ${clients.map(c => {
            const notes = (c.notes || '').trim();
            const notePreview = notes.length > 45 ? notes.slice(0, 45) + 'â€¦' : notes;
            return `
            <tr id="client-row-${c.id}">
              <td style="white-space:nowrap;font-weight:500">${c.name}</td>
              <td><a href="mailto:${c.email}" style="color:var(--accent2);font-size:12px">${c.email || 'â€”'}</a></td>
              <td style="font-size:12px;white-space:nowrap">${c.phone || 'â€”'}</td>
              <td>${statusTag(c.status)}</td>
              <td class="notes-cell">
                ${notePreview || '<span style="color:var(--border)">â€”</span>'}
                ${notes.length > 45 ? `<button class="secondary" onclick="viewNotes('${c.name.replace(/'/g,"\\'")}', \`${notes.replace(/`/g,'\\`')}\`)" style="font-size:10px;padding:2px 6px;margin-left:4px">View</button>` : ''}
              </td>
              <td style="color:var(--muted);font-size:11px;white-space:nowrap">${formatDate(c.created_at)}</td>
              <td>
                <div class="actions">
                  <button class="secondary" onclick='openEditClient(${JSON.stringify(c)})' style="font-size:12px;padding:5px 10px">Edit</button>
                  <button class="danger" onclick="deleteClient(${c.id}, '${c.name.replace(/'/g,"\\'")}')">âœ•</button>
                </div>
              </td>
            </tr>`}).join('')}
        </tbody>
      </table>`;
  }

  async function loadClients() {
    try {
      const r = await fetch('/api/clients');
      _clientsCache = await r.json();
      renderClientSummary(_clientsCache);
      renderClients();
    } catch(e) {
      document.getElementById('clients-container').innerHTML =
        `<div class="empty-state"><div class="icon">âš ï¸</div><p>Failed to load.</p></div>`;
    }
  }

  function viewNotes(name, notes) {
    document.getElementById('notes-modal-title').textContent = `ğŸ“ ${name} â€” Notes`;
    document.getElementById('notes-modal-body').textContent = notes;
    openModal('notes-modal');
  }

  // â”€â”€ Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _propsCache = [];
  let _propSort   = { field: 'status', dir: 1 };

  function setPropSort(field) {
    if (_propSort.field === field) _propSort.dir *= -1;
    else _propSort = { field, dir: 1 };
    document.querySelectorAll('[id^="psort-"]').forEach(b => b.classList.remove('sort-active'));
    document.getElementById(`psort-${field}`)?.classList.add('sort-active');
    renderProperties();
  }

  function sortProps(props) {
    return [...props].sort((a, b) => {
      const { field, dir } = _propSort;
      if (field === 'status') {
        const diff = (STATUS_ORDER[a.status] ?? 1) - (STATUS_ORDER[b.status] ?? 1);
        return diff !== 0 ? diff : a.address.localeCompare(b.address);
      }
      if (field === 'address') return dir * a.address.localeCompare(b.address);
      if (field === 'price') {
        const ap = a.price_monthly || a.price_sale || 0;
        const bp = b.price_monthly || b.price_sale || 0;
        return dir * (ap - bp);
      }
      return 0;
    });
  }

  function renderPropSummary(props) {
    const counts = { tbd: 0, active: 0, inactive: 0, closed: 0 };
    props.forEach(p => { counts[p.status] = (counts[p.status] || 0) + 1; });
    const items = [
      { label: 'TBD',      key: 'tbd',      color: 'var(--yellow)' },
      { label: 'Active',   key: 'active',   color: 'var(--green)'  },
      { label: 'Inactive', key: 'inactive', color: 'var(--muted)'  },
      { label: 'Closed',   key: 'closed',   color: 'var(--red)'    },
    ];
    document.getElementById('props-summary').innerHTML = items.map(i => `
      <div class="stat-card">
        <div class="label">${i.label}</div>
        <div class="value" style="font-size:24px;color:${i.color}">${counts[i.key] || 0}</div>
        <div class="sub">Properties</div>
      </div>`).join('');
  }

  function renderProperties() {
    const container = document.getElementById('properties-container');
    const props = sortProps(_propsCache);
    if (!props.length) {
      container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ¢</div><p>No properties yet.</p></div>`;
      return;
    }
    container.innerHTML = `
      <table class="tight">
        <thead><tr>
          <th>Address</th><th>Type</th><th>Bd/Ba</th><th>Price</th><th>Status</th><th>Notes</th><th></th>
        </tr></thead>
        <tbody>
          ${props.map(p => {
            const notes = (p.notes || '').trim();
            const notePreview = notes.length > 35 ? notes.slice(0, 35) + 'â€¦' : notes;
            return `
            <tr>
              <td style="font-weight:500;font-size:12px">${p.address}</td>
              <td><span class="tag ${p.type}">${p.type}</span></td>
              <td style="font-size:12px;white-space:nowrap">${p.bedrooms || 'â€”'}bd / ${p.bathrooms || 'â€”'}ba</td>
              <td style="font-size:12px;white-space:nowrap">${p.price_monthly ? '$' + p.price_monthly.toLocaleString() + '/mo' : p.price_sale ? '$' + p.price_sale.toLocaleString() : 'â€”'}</td>
              <td>${statusTag(p.status)}</td>
              <td class="notes-cell">
                ${notePreview || '<span style="color:var(--border)">â€”</span>'}
                ${notes.length > 35 ? `<button class="secondary" onclick="viewNotes('${p.address.replace(/'/g,"\\'")}', \`${notes.replace(/`/g,'\\`')}\`)" style="font-size:10px;padding:2px 6px;margin-left:4px">View</button>` : ''}
              </td>
              <td>
                <div class="actions">
                  <button class="secondary" onclick='openEditProperty(${JSON.stringify(p)})' style="font-size:12px;padding:5px 10px">Edit</button>
                  <button class="danger" onclick="deleteProperty(${p.id}, '${p.address.replace(/'/g,"\\'")}')">âœ•</button>
                </div>
              </td>
            </tr>`}).join('')}
        </tbody>
      </table>`;
  }

  async function loadProperties() {
    try {
      const r = await fetch('/api/properties');
      _propsCache = await r.json();
      renderPropSummary(_propsCache);
      renderProperties();
    } catch(e) {
      document.getElementById('properties-container').innerHTML =
        `<div class="empty-state"><div class="icon">âš ï¸</div><p>Failed to load.</p></div>`;
    }
  }

  function openAddPropertyModal() { openEditProperty({}); }

  function openEditProperty(p) {
    document.getElementById('prop-edit-id').value              = p.id || '';
    document.getElementById('prop-edit-address').value         = p.address || '';
    document.getElementById('prop-edit-type').value            = p.type    || 'rental';
    document.getElementById('prop-edit-status').value          = p.status  || 'active';
    document.getElementById('prop-edit-price-monthly').value   = p.price_monthly || '';
    document.getElementById('prop-edit-price-sale').value      = p.price_sale    || '';
    document.getElementById('prop-edit-bedrooms').value        = p.bedrooms  || '';
    document.getElementById('prop-edit-bathrooms').value       = p.bathrooms || '';
    document.getElementById('prop-edit-notes').value           = p.notes    || '';
    document.getElementById('property-edit-title').textContent = p.id ? 'ğŸ¢ Edit Property' : 'ğŸ¢ Add Property';
    openModal('property-edit-modal');
  }

  async function saveProperty() {
    const id = document.getElementById('prop-edit-id').value;
    const body = {
      address:       document.getElementById('prop-edit-address').value.trim(),
      type:          document.getElementById('prop-edit-type').value,
      status:        document.getElementById('prop-edit-status').value,
      price_monthly: parseInt(document.getElementById('prop-edit-price-monthly').value) || null,
      price_sale:    parseInt(document.getElementById('prop-edit-price-sale').value)    || null,
      bedrooms:      parseInt(document.getElementById('prop-edit-bedrooms').value)      || null,
      bathrooms:     parseFloat(document.getElementById('prop-edit-bathrooms').value)   || null,
      notes:         document.getElementById('prop-edit-notes').value.trim() || null,
    };
    if (!body.address) { alert('Address is required.'); return; }

    const url    = id ? `/api/properties/${id}` : '/api/properties';
    const method = id ? 'PATCH' : 'POST';
    const r = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const d = await r.json();
    if (!d.ok) { alert('Save failed: ' + (d.error || 'unknown')); return; }
    closeModal('property-edit-modal');
    await loadProperties();
    await refreshStats();
  }

  async function deleteProperty(id, address) {
    if (!confirm(`Remove "${address}"?`)) return;
    await fetch(`/api/properties/${id}`, { method: 'DELETE' });
    await loadProperties();
    await refreshStats();
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function formatDate(iso) {
    if (!iso) return 'â€”';
    return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  async function refreshAll() {
    await Promise.all([checkAuth(), refreshStats()]);
  }

  // â”€â”€ Poll interval display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setPollDisplay() {
    const secs = 300; // default, could fetch from /health
    const mins = Math.round(secs / 60);
    document.getElementById('poll-interval-display').textContent =
      mins >= 1 ? `Every ${mins} minute${mins > 1 ? 's' : ''}` : `Every ${secs}s`;
  }

  // â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  // Close on backdrop click
  document.querySelectorAll('.modal-overlay').forEach(el => {
    el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
  });

  // â”€â”€ Draft reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateDraft(leadId, btn) {
    btn.disabled = true;
    btn.textContent = 'â³ Drafting...';

    document.getElementById('draft-modal-content').innerHTML =
      '<p style="color:var(--muted);text-align:center;padding:20px">Generating with Claude Sonnet...</p>';
    document.getElementById('draft-gmail-link').style.display = 'none';
    openModal('draft-modal');

    try {
      const r = await fetch(`/api/leads/${leadId}/draft`, { method: 'POST' });
      const d = await r.json();

      if (!d.ok) throw new Error(d.error || 'Draft failed');

      document.getElementById('draft-modal-content').innerHTML = `
        <div style="margin-bottom:12px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:4px">Subject</div>
          <div style="font-size:13px;font-weight:500">${d.subject}</div>
        </div>
        <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px">Reply</div>
        <div class="draft-preview">${d.body}</div>
        ${d.gmail_draft_id
          ? '<p style="margin-top:12px;font-size:12px;color:var(--green)">âœ“ Saved to Gmail Drafts</p>'
          : '<p style="margin-top:12px;font-size:12px;color:var(--muted)">Draft saved locally (Gmail draft unavailable)</p>'
        }`;

      if (d.gmail_draft_id) {
        const gmailLink = document.getElementById('draft-gmail-link');
        gmailLink.href = 'https://mail.google.com/mail/#drafts';
        gmailLink.style.display = 'inline-flex';
      }

      btn.textContent = 'âœ“ Drafted';
      loadDrafts(); // refresh badge
    } catch(e) {
      document.getElementById('draft-modal-content').innerHTML =
        `<p style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</p>`;
      btn.disabled = false;
      btn.textContent = 'âœ Draft';
    }
  }

  // â”€â”€ Drafts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _draftsCache = [];

  async function loadDrafts() {
    const container = document.getElementById('drafts-container');
    try {
      const r = await fetch('/api/drafts');
      _draftsCache = await r.json();
      const drafts = _draftsCache;

      const badge = document.getElementById('drafts-badge');
      badge.textContent = drafts.length;
      badge.className   = 'badge' + (drafts.length > 0 ? '' : ' zero');
      document.getElementById('drafts-count').textContent =
        drafts.length ? `${drafts.length} pending` : '';

      if (!drafts.length) {
        container.innerHTML = `<div class="empty-state"><div class="icon">âœ</div><p>No pending drafts. Click "+ New Draft" or use the Draft button in Inbox.</p></div>`;
        return;
      }

      const statusColor = { local: 'var(--muted)', gmail_draft: 'var(--accent2)', failed: 'var(--red)', duplicate: 'var(--yellow)' };
      const statusLabel = { local: 'ğŸ’¾ Local', gmail_draft: 'ğŸ“¨ Gmail Draft', failed: 'âŒ Failed', duplicate: 'âš ï¸ Duplicate â€” edit to unlock' };

      container.innerHTML = `
        <table>
          <thead><tr>
            <th>To</th><th>Subject</th><th>Status</th><th>Created</th><th>Actions</th>
          </tr></thead>
          <tbody>
            ${drafts.map(d => `
              <tr id="draft-row-${d.id}">
                <td style="color:var(--accent2)">${d.to_email || 'â€”'}</td>
                <td>${d.subject || 'â€”'}</td>
                <td>
                  <span style="font-size:12px;color:${statusColor[d.status] || 'var(--muted)'}">${statusLabel[d.status] || d.status}</span>
                  ${d.error_msg ? `<div style="font-size:10px;color:var(--red);margin-top:2px">${d.error_msg}</div>` : ''}
                </td>
                <td style="color:var(--muted);font-size:12px">${formatDate(d.created_at)}</td>
                <td>
                  <div class="actions">
                    <button class="secondary" onclick="editDraft(${d.id})">Edit</button>
                    <button class="secondary" onclick="duplicateDraft(${d.id})" title="Duplicate this draft">â§‰ Dupe</button>
                    ${d.status === 'local' || d.status === 'failed'
                      ? `<button class="secondary" onclick="pushDraftToGmail(${d.id}, this)">ğŸ“¨ Gmail</button>`
                      : ''}
                    <button class="danger" onclick="deleteDraft(${d.id})">Delete</button>
                  </div>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    } catch(e) {
      container.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><p>Failed to load drafts.</p></div>`;
    }
  }

  function openNewDraftModal() {
    document.getElementById('draft-edit-id').value      = '';
    document.getElementById('draft-edit-to').value      = '';
    document.getElementById('draft-edit-subject').value = '';
    document.getElementById('draft-edit-body').innerHTML = '';
    document.getElementById('draft-edit-title').textContent = 'âœ New Draft';
    openModal('draft-edit-modal');
  }

  function editDraft(id) {
    const d = _draftsCache.find(x => x.id === id);
    if (!d) return;
    document.getElementById('draft-edit-id').value       = id;
    document.getElementById('draft-edit-to').value       = d.to_email || '';
    document.getElementById('draft-edit-subject').value  = d.subject  || '';
    document.getElementById('draft-edit-body').innerHTML = d.body     || '';
    document.getElementById('draft-edit-title').textContent = 'âœ Edit Draft';
    openModal('draft-edit-modal');
  }

  function draftFmt(cmd, val) {
    document.getElementById('draft-edit-body').focus();
    document.execCommand(cmd, false, val || null);
  }

  async function saveDraft(mode) {
    const id      = document.getElementById('draft-edit-id').value;
    const to      = document.getElementById('draft-edit-to').value.trim();
    const subject = document.getElementById('draft-edit-subject').value.trim();
    const body    = document.getElementById('draft-edit-body').innerHTML.trim();

    if (!to || !subject) { alert('To and Subject are required.'); return; }

    const payload = { to_email: to, subject, body };

    if (id) {
      // Update existing
      await fetch(`/api/drafts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (mode === 'gmail') await pushDraftToGmailById(parseInt(id));
    } else {
      // Create new
      const r = await fetch('/api/drafts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const d = await r.json();
      if (mode === 'gmail' && d.id) await pushDraftToGmailById(d.id);
    }

    closeModal('draft-edit-modal');
    await loadDrafts();
  }

  async function pushDraftToGmail(id, btn) {
    if (btn) { btn.disabled = true; btn.textContent = '...'; }
    await pushDraftToGmailById(id);
    await loadDrafts();
  }

  async function pushDraftToGmailById(id) {
    const r = await fetch(`/api/drafts/${id}/push-gmail`, { method: 'POST' });
    const d = await r.json();
    if (!d.ok) alert(`Gmail push failed: ${d.error}`);
  }

  async function duplicateDraft(id) {
    const r = await fetch(`/api/drafts/${id}/duplicate`, { method: 'POST' });
    const d = await r.json();
    if (d.ok) await loadDrafts();
    else alert('Duplicate failed: ' + d.error);
  }

  async function deleteDraft(id) {
    if (!confirm('Delete this draft?')) return;
    await fetch(`/api/drafts/${id}`, { method: 'DELETE' });
    document.getElementById(`draft-row-${id}`)?.remove();
    await loadDrafts();
  }

  // â”€â”€ Client picker for draft modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openClientPicker() {
    const r = await fetch('/api/clients');
    const clients = await r.json();
    const list = document.getElementById('client-picker-list');
    if (!clients.length) {
      list.innerHTML = `<div class="empty-state"><p>No clients yet.</p></div>`;
    } else {
      list.innerHTML = clients.map(c => `
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:space-between"
             onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background=''"
             onclick="pickClient('${c.email}', '${(c.name || '').replace(/'/g,"\\'")}')">
          <div>
            <div style="font-size:13px;font-weight:500">${c.name}</div>
            <div style="font-size:11px;color:var(--muted)">${c.email || 'â€”'}</div>
          </div>
          <span style="color:var(--accent2);font-size:12px">Select â†’</span>
        </div>`).join('');
    }
    openModal('client-picker-modal');
  }

  function pickClient(email, name) {
    document.getElementById('draft-edit-to').value = email;
    const subj = document.getElementById('draft-edit-subject');
    if (!subj.value) subj.value = `Re: Property Inquiry â€” ${name}`;
    closeModal('client-picker-modal');
  }

  // â”€â”€ Send All â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function confirmSendAll() {
    const r = await fetch('/api/drafts');
    const drafts = await r.json();
    const pending   = drafts.filter(d => ['local','gmail_draft','failed'].includes(d.status));
    const dupeCount = drafts.filter(d => d.status === 'duplicate').length;
    document.getElementById('send-all-count').textContent =
      `${pending.length} email${pending.length !== 1 ? 's' : ''} will be sent.` +
      (dupeCount ? ` (${dupeCount} duplicate${dupeCount > 1 ? 's' : ''} excluded)` : '');
    openModal('send-all-modal');
  }

  async function executeSendAll() {
    closeModal('send-all-modal');
    const btn = document.getElementById('send-all-btn');
    btn.disabled = true;
    btn.textContent = 'ğŸ“¤ Sending...';

    try {
      const r = await fetch('/api/drafts/send-all', { method: 'POST' });
      const d = await r.json();
      await loadDrafts();
      if (d.failed > 0) {
        alert(`Sent: ${d.sent} âœ“\nFailed: ${d.failed} â€” failed drafts remain in the list.`);
      } else {
        alert(`All ${d.sent} draft${d.sent !== 1 ? 's' : ''} sent successfully âœ“`);
      }
    } catch(e) {
      alert('Send failed â€” check your Gmail connection.');
    }

    btn.disabled = false;
    btn.textContent = 'ğŸ“¤ Send All Drafts';
  }

  // â”€â”€ Edit / Add Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openEditClient(c) {
    document.getElementById('client-edit-id').value      = c.id || '';
    document.getElementById('client-edit-name').value    = c.name    || '';
    document.getElementById('client-edit-email').value   = c.email   || '';
    document.getElementById('client-edit-phone').value   = c.phone   || '';
    document.getElementById('client-edit-address').value = c.address || '';
    document.getElementById('client-edit-notes').value   = c.notes   || '';
    document.getElementById('client-edit-status').value  = c.status  || 'active';
    document.getElementById('client-edit-title').textContent = c.id ? 'ğŸ‘¤ Edit Client' : 'ğŸ‘¤ Add Client';
    openModal('client-edit-modal');
  }

  async function saveClient() {
    const id = document.getElementById('client-edit-id').value;
    const body = {
      name:    document.getElementById('client-edit-name').value.trim(),
      email:   document.getElementById('client-edit-email').value.trim() || null,
      phone:   document.getElementById('client-edit-phone').value.trim() || null,
      address: document.getElementById('client-edit-address').value.trim() || null,
      notes:   document.getElementById('client-edit-notes').value.trim() || null,
      status:  document.getElementById('client-edit-status').value,
    };
    if (!body.name) { alert('Name is required.'); return; }

    const url    = id ? `/api/clients/${id}` : '/api/clients';
    const method = id ? 'PATCH' : 'POST';
    const r = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const d = await r.json();
    if (!d.ok) { alert('Save failed: ' + (d.error || 'unknown error')); return; }
    closeModal('client-edit-modal');
    await loadClients();
    await refreshStats();
  }

  // â”€â”€ Delete client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function deleteClient(id, name) {
    if (!confirm(`Remove ${name} from your client list?`)) return;
    await fetch(`/api/clients/${id}`, { method: 'DELETE' });
    document.getElementById(`client-row-${id}`)?.remove();
    refreshStats();
  }

  // â”€â”€ Signature toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleSig() {
    const track = document.getElementById('sig-track');
    const wrap  = document.getElementById('sig-editor-wrap');
    const label = document.getElementById('sig-toggle-label');
    const on    = !track.classList.contains('on');
    track.classList.toggle('on', on);
    wrap.style.display  = on ? 'block' : 'none';
    label.textContent   = on ? 'On' : 'Off';
  }

  function setSigToggle(enabled) {
    const track = document.getElementById('sig-track');
    const wrap  = document.getElementById('sig-editor-wrap');
    const label = document.getElementById('sig-toggle-label');
    track.classList.toggle('on', enabled);
    wrap.style.display = enabled ? 'block' : 'none';
    label.textContent  = enabled ? 'On' : 'Off';
  }

  // â”€â”€ Signature editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sigFmt(cmd, val) {
    document.getElementById('sig-editor').focus();
    document.execCommand(cmd, false, val || null);
  }

  // â”€â”€ Agent Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openProfileModal() {
    const r = await fetch('/api/profile');
    const p = await r.json();
    document.getElementById('profile-name').value    = p.agent_name    || '';
    document.getElementById('profile-company').value = p.agent_company || '';
    document.getElementById('profile-tone').value    = p.agent_tone    || 'professional and warm';
    // Signature: stored as HTML, render in contenteditable
    document.getElementById('sig-editor').innerHTML = p.agent_signature || '';
    setSigToggle(p.agent_signature_enabled === 'true');
    openModal('profile-modal');
  }

  async function saveProfile() {
    const sigEnabled = document.getElementById('sig-track').classList.contains('on');
    const body = {
      agent_name:             document.getElementById('profile-name').value.trim(),
      agent_company:          document.getElementById('profile-company').value.trim(),
      agent_tone:             document.getElementById('profile-tone').value,
      agent_signature:        document.getElementById('sig-editor').innerHTML.trim(),
      agent_signature_enabled: String(sigEnabled),
    };
    if (!body.agent_name) { alert('Name is required.'); return; }
    await fetch('/api/profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    closeModal('profile-modal');
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('header-date').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  refreshAll();
  loadLeads();   // preload for dashboard recent leads
  loadDrafts();  // preload drafts badge
  setPollDisplay();
  buildSwatches();
  setInterval(refreshAll, 30000);

  // Pull version from API
  fetch('/health').then(r => r.json()).then(d => {
    if (d.version) document.getElementById('app-version').textContent = 'v' + d.version;
  }).catch(() => {});
</script>
</body>
</html>
